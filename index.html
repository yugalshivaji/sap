<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi-NCR Air Quality Monitor</title>
    <meta name="description" content="Personalized air quality dashboard for Delhi-NCR citizens with health alerts, forecasts and recommendations">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0d6efd;
            --secondary: #6c757d;
            --success: #198754;
            --info: #0dcaf0;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 280px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
        }
        
        /* Mobile-first responsive design */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header Styles - FIXED */
        .app-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
        }
        
        .header-icon {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            margin-left: 15px;
            cursor: pointer;
            position: relative;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding-top: 70px;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
        }
        
        .sidebar-overlay.open {
            display: block;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-menu li {
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #f0f5ff;
            color: var(--primary);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            transition: margin-left 0.3s;
        }
        
        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* AQI Status Colors */
        .aqi-good { background-color: #28a745; color: white; }
        .aqi-moderate { background-color: #ffc107; color: black; }
        .aqi-unhealthy-sensitive { background-color: #fd7e14; color: white; }
        .aqi-unhealthy { background-color: #dc3545; color: white; }
        .aqi-very-unhealthy { background-color: #6f42c1; color: white; }
        .aqi-hazardous { background-color: #6c757d; color: white; }
        
        /* Map Container */
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
        }
        
        /* Tab Styles */
        .nav-tabs .nav-link {
            border: none;
            color: var(--secondary);
            padding: 10px 15px;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            background: transparent;
        }
        
        /* Form Styles */
        .form-floating {
            position: relative;
        }
        
        .password-toggle {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .sidebar {
                position: static;
                width: var(--sidebar-width);
                height: 100vh;
                left: 0;
            }
            
            .main-content {
                flex: 1;
                margin-left: 0;
            }
            
            .menu-toggle {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
        }
        
        @media (max-width: 767px) {
            .sidebar {
                width: 85%;
                max-width: 300px;
            }
            
            .app-header {
                padding: 12px 15px;
            }
            
            .logo {
                font-size: 1.1rem;
            }
            
            .header-icon {
                margin-left: 10px;
                font-size: 1.1rem;
            }
            
            .menu-toggle {
                margin-right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                padding: 10px 12px;
            }
            
            .logo {
                font-size: 1rem;
            }
            
            .header-icon {
                margin-left: 8px;
                font-size: 1rem;
            }
            
            .menu-toggle {
                margin-right: 8px;
                font-size: 1.3rem;
            }
        }

        /* Authentication Styles */
        .auth-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 50px auto;
            max-width: 500px;
        }
        
        .auth-header {
            background: var(--primary);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .auth-tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .auth-content {
            padding: 30px;
        }
        
        /* Multi-step form styles */
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }
        
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            font-weight: bold;
        }
        
        .step.active {
            background-color: var(--primary);
            color: white;
        }
        
        .step.completed {
            background-color: var(--success);
            color: white;
        }
        
        /* Health questionnaire styles */
        .health-question {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        /* OTP input styles */
        .otp-container {
            display: none;
        }
        
        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            margin: 0 5px;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        
        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 60px;
            right: -350px;
            width: 320px;
            height: calc(100vh - 60px);
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 997;
            padding: 20px;
            overflow-y: auto;
        }
        
        .notification-panel.open {
            right: 0;
        }
        
        .notification-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        /* Profile Panel */
        .profile-panel {
            position: fixed;
            top: 60px;
            right: -350px;
            width: 320px;
            height: calc(100vh - 60px);
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 997;
            padding: 20px;
            overflow-y: auto;
        }
        
        .profile-panel.open {
            right: 0;
        }
        
        .profile-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 15px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .aqi-legend {
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .firebase-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .firebase-config h5 {
            color: #ffa000;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Firebase Configuration Instructions -->
    <div id="firebase-setup" class="firebase-config" style="display: none;">
        <div class="container">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Firebase Setup Required</h5>
            <p>To enable all features, please configure Firebase:</p>
            <ol>
                <li>Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                <li>Create a new project or select existing one</li>
                <li>Enable Authentication (Email/Password)</li>
                <li>Enable Firestore Database</li>
                <li>Enable Storage (for complaint images)</li>
                <li>Copy your Firebase config and paste it below:</li>
            </ol>
            <div class="mb-3">
                <label class="form-label">Firebase Configuration</label>
                <textarea id="firebaseConfigInput" class="form-control" rows="8" placeholder='{
  "apiKey": "AIzaSyC-UoKd0kM8EnviJBWlUFI2NmNAKzmWVXo",
  "authDomain": "aqi-monitor-delhi-ncr.firebaseapp.com",
  "projectId": "aqi-monitor-delhi-ncr",
  "storageBucket": "aqi-monitor-delhi-ncr.firebasestorage.app",
  "messagingSenderId": "1030677751725",
  "appId": "1:1030677751725:web:5d976181ad6151b5562324"
}'></textarea>
            </div>
            <button id="saveFirebaseConfig" class="btn btn-primary">Save Firebase Configuration</button>
        </div>
    </div>

    <!-- Authentication Section (Initially shown) -->
    <div id="auth-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                    <div class="auth-container">
                        <div class="auth-header">
                            <h1><i class="fas fa-lungs me-2"></i>AQI Monitor Delhi-NCR</h1>
                            <p class="mb-0">Create your account or login to access personalized air quality dashboard</p>
                        </div>
                        
                        <div class="auth-tabs">
                            <div class="auth-tab active" id="login-tab">Login</div>
                            <div class="auth-tab" id="register-tab">Register</div>
                        </div>
                        
                        <div class="auth-content">
                            <!-- Login Form -->
                            <div id="login-form" class="auth-panel">
                                <h3 class="text-center mb-4">Login to Your Account</h3>
                                
                                <div class="alert alert-info">
                                    <strong>Default Credentials:</strong> username: demo | password: demo123
                                </div>
                                
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                            <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">Password</label>
                                        <div class="form-floating">
                                            <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required>
                                            <span class="password-toggle" onclick="togglePassword('loginPassword')">
                                                <i class="fas fa-eye"></i>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="rememberMe">
                                        <label class="form-check-label" for="rememberMe">Remember me</label>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <span id="loginSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                            Login
                                        </button>
                                    </div>
                                    
                                    <div class="text-center mt-3">
                                        <a href="#" id="forgotPasswordLink">Forgot Password?</a>
                                    </div>
                                </form>
                                
                                <!-- Forgot Password Form -->
                                <div id="forgotPasswordForm" class="mt-4" style="display: none;">
                                    <h5 class="mb-3">Reset Your Password</h5>
                                    <form id="resetPasswordForm">
                                        <div class="mb-3">
                                            <label for="resetEmail" class="form-label">Email Address</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                <input type="email" class="form-control" id="resetEmail" placeholder="Enter your registered email" required>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2 mb-3">
                                            <button type="button" class="btn btn-outline-primary" id="sendResetLinkBtn">
                                                <span id="resetSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                                Send Reset Link
                                            </button>
                                        </div>
                                        
                                        <div class="alert alert-info" id="resetMessage" style="display: none;">
                                            Password reset email sent! Check your inbox.
                                        </div>
                                    </form>
                                    
                                    <div class="text-center mt-3">
                                        <a href="#" id="backToLogin">Back to Login</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Registration Form -->
                            <div id="register-form" class="auth-panel" style="display: none;">
                                <h3 class="text-center mb-4">Create Your Account</h3>
                                
                                <div class="step-indicator">
                                    <div class="step active" id="step1">1</div>
                                    <div class="step" id="step2">2</div>
                                    <div class="step" id="step3">3</div>
                                    <div class="step" id="step4">4</div>
                                </div>
                                
                                <form id="registrationForm">
                                    <!-- Step 1: Personal Details -->
                                    <div class="form-step active" id="step1-form">
                                        <h5 class="mb-3">Personal Information</h5>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fullName" class="form-label">Full Name</label>
                                                <input type="text" class="form-control" id="fullName" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="email" class="form-label">Email Address</label>
                                                <input type="email" class="form-control" id="email" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="mobile" class="form-label">Mobile Number</label>
                                                <input type="tel" class="form-control" id="mobile" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="dob" class="form-label">Date of Birth</label>
                                                <input type="date" class="form-control" id="dob" required>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <div></div> <!-- Empty div for spacing -->
                                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2: Address Details -->
                                    <div class="form-step" id="step2-form">
                                        <h5 class="mb-3">Address Information</h5>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="state" class="form-label">State</label>
                                                <select class="form-select" id="state" required>
                                                    <option value="">Select State</option>
                                                    <option value="Delhi">Delhi</option>
                                                    <option value="Haryana">Haryana</option>
                                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                    <option value="Rajasthan">Rajasthan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="city" class="form-label">City</label>
                                                <select class="form-select" id="city" required>
                                                    <option value="">Select City</option>
                                                    <!-- Cities will be populated based on state selection -->
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="address" class="form-label">Full Address</label>
                                            <textarea class="form-control" id="address" rows="3" required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="pincode" class="form-label">Pincode</label>
                                            <input type="text" class="form-control" id="pincode" maxlength="6" required>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-outline-secondary" onclick="prevStep(1)">Previous</button>
                                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 3: Health Questionnaire -->
                                    <div class="form-step" id="step3-form">
                                        <h5 class="mb-3">Health Information</h5>
                                        <p class="text-muted">This information helps us provide personalized air quality recommendations.</p>
                                        
                                        <div class="health-question">
                                            <label class="form-label">Do you have any respiratory conditions?</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="respiratory" id="respiratoryYes" value="yes">
                                                <label class="form-check-label" for="respiratoryYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="respiratory" id="respiratoryNo" value="no" checked>
                                                <label class="form-check-label" for="respiratoryNo">No</label>
                                            </div>
                                            <div class="mt-2" id="respiratoryDetails" style="display: none;">
                                                <label class="form-label">Please specify:</label>
                                                <select class="form-select" id="respiratoryCondition">
                                                    <option value="">Select condition</option>
                                                    <option value="asthma">Asthma</option>
                                                    <option value="copd">COPD</option>
                                                    <option value="bronchitis">Chronic Bronchitis</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="health-question">
                                            <label class="form-label">Do you have any cardiovascular conditions?</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="cardio" id="cardioYes" value="yes">
                                                <label class="form-check-label" for="cardioYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="cardio" id="cardioNo" value="no" checked>
                                                <label class="form-check-label" for="cardioNo">No</label>
                                            </div>
                                        </div>
                                        
                                        <div class="health-question">
                                            <label class="form-label">Are you a smoker?</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="smoker" id="smokerYes" value="yes">
                                                <label class="form-check-label" for="smokerYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="smoker" id="smokerNo" value="no" checked>
                                                <label class="form-check-label" for="smokerNo">No</label>
                                            </div>
                                        </div>
                                        
                                        <div class="health-question">
                                            <label class="form-label">How would you describe your activity level?</label>
                                            <select class="form-select" id="activityLevel">
                                                <option value="sedentary">Mostly indoors (sedentary)</option>
                                                <option value="light">Light activity (walking, light exercise)</option>
                                                <option value="moderate">Moderate activity (regular exercise)</option>
                                                <option value="high">High activity (athlete, construction worker)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="health-question">
                                            <label class="form-label">Age Group</label>
                                            <select class="form-select" id="ageGroup">
                                                <option value="child">Under 18</option>
                                                <option value="young">18-35</option>
                                                <option value="middle">36-60</option>
                                                <option value="senior">Over 60</option>
                                            </select>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-outline-secondary" onclick="prevStep(2)">Previous</button>
                                            <button type="button" class="btn btn-primary" onclick="nextStep(4)">Next</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 4: Account Setup -->
                                    <div class="form-step" id="step4-form">
                                        <h5 class="mb-3">Account Setup</h5>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="password" class="form-label">Password</label>
                                                <div class="form-floating">
                                                    <input type="password" class="form-control" id="password" required>
                                                    <span class="password-toggle" onclick="togglePassword('password')">
                                                        <i class="fas fa-eye"></i>
                                                    </span>
                                                </div>
                                                <div class="form-text">Password must be at least 8 characters long</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="confirmPasswordReg" class="form-label">Confirm Password</label>
                                                <div class="form-floating">
                                                    <input type="password" class="form-control" id="confirmPasswordReg" required>
                                                    <span class="password-toggle" onclick="togglePassword('confirmPasswordReg')">
                                                        <i class="fas fa-eye"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="terms" required>
                                            <label class="form-check-label" for="terms">I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></label>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-outline-secondary" onclick="prevStep(3)">Previous</button>
                                            <button type="submit" class="btn btn-success">
                                                <span id="registerSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                                Create Account
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (Initially hidden) -->
    <div id="dashboard-section" class="app-container" style="display: none;">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" data-section="notices"><i class="fas fa-bullhorn"></i> Notices Board</a></li>
                <li><a href="#" data-section="complaints"><i class="fas fa-exclamation-triangle"></i> Complaints</a></li>
                <li><a href="#" data-section="map"><i class="fas fa-map-marked-alt"></i> AQI Map</a></li>
                <li><a href="#" data-section="carbon"><i class="fas fa-leaf"></i> Carbon Footprint</a></li>
                <li><a href="#" data-section="hospitals"><i class="fas fa-hospital"></i> Nearby Hospitals</a></li>
                <li><a href="#" data-section="profile"><i class="fas fa-user-cog"></i> Profile Settings</a></li>
                <li><a href="#" data-section="feedback"><i class="fas fa-comment-dots"></i> Feedback</a></li>
                <li><a href="#" id="logout-sidebar"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>
        
        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <i class="fas fa-lungs me-2"></i>AQI Monitor
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-icon" id="notificationsBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                    <button class="header-icon" id="profileBtn">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </header>
            
            <!-- Dashboard Content (Default Section) -->
            <section class="content-section active" id="dashboard-section-content">
                <!-- Header Section -->
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h1 class="display-5 fw-bold text-primary">Citizens Air Quality Dashboard</h1>
                        <p class="lead text-muted">Real-time monitoring & personalized health recommendations</p>
                        <small class="text-muted">Last updated: <span id="lastUpdated">Loading...</span> | Auto-refresh every 5 minutes</small>
                    </div>
                </div>

                <!-- Alert Section -->
                <div class="row mb-4" id="healthAlert" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Health Alert</h5>
                                <p class="mb-0" id="alertMessage">Current air quality may affect sensitive individuals. Limit outdoor activities.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main AQI Display -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-body text-center py-4">
                                <h3 class="text-muted mb-3">Current Average AQI - Delhi NCR</h3>
                                <div class="display-1 fw-bold mb-3" id="mainAQI">Loading...</div>
                                <div class="badge fs-5 px-4 py-2 mb-4" id="mainAQICategory">Calculating...</div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar" id="aqiProgress"></div>
                                </div>
                                <p class="text-muted" id="aqiDescription">Analyzing air quality data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-6 col-md-3 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-thermometer-half fa-2x text-info mb-3"></i>
                                <h5>Temperature</h5>
                                <div class="h4 fw-bold" id="temperature">--Â°C</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-wind fa-2x text-primary mb-3"></i>
                                <h5>Wind Speed</h5>
                                <div class="h4 fw-bold" id="windSpeed">-- m/s</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-tint fa-2x text-success mb-3"></i>
                                <h5>Humidity</h5>
                                <div class="h4 fw-bold" id="humidity">--%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-eye fa-2x text-warning mb-3"></i>
                                <h5>Visibility</h5>
                                <div class="h4 fw-bold" id="visibility">-- km</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 72-Hour Forecast -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>72-Hour AQI Forecast</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Station Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Nearby Station Air Quality</h4>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="stationDetails">
                                    <!-- Station cards will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Recommendations -->
                <div class="row mb-4">
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-heart me-2"></i>Health Recommendations</h5>
                            </div>
                            <div class="card-body">
                                <div id="healthRecommendations">
                                    <!-- Recommendations will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="dashboard-card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Activity Suggestions</h5>
                            </div>
                            <div class="card-body">
                                <div id="activitySuggestions">
                                    <!-- Activity suggestions will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pollutant Breakdown -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fas fa-flask me-2"></i>Current Pollutant Levels</h4>
                            </div>
                            <div class="card-body">
                                <div class="row" id="pollutantLevels">
                                    <!-- Pollutant data will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SOS Alert Note -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>Automatic SOS Alert System</h5>
                            <p class="mb-0">In case of consistently bad AQI levels (based on current and forecasted data), an automatic SOS alert will be sent to nearby hospitals. This ensures they can prepare necessary resources like beds and oxygen cylinders in advance.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Other sections remain the same as in your original code -->
            <!-- Notices Board, Complaints, AQI Map, Carbon Footprint, Nearby Hospitals, Profile Settings, Feedback sections -->
            <!-- ... (content unchanged from your original code) ... -->
            
        </div>
        
        <!-- Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <h5 class="mb-3">Notifications</h5>
            <div class="notification-item">
                <div class="fw-bold">Health Alert</div>
                <div class="small text-muted">AQI in your area has reached unhealthy levels</div>
                <div class="small text-muted">2 hours ago</div>
            </div>
            <div class="notification-item">
                <div class="fw-bold">Complaint Update</div>
                <div class="small text-muted">Your complaint #45632 has been resolved</div>
                <div class="small text-muted">1 day ago</div>
            </div>
            <div class="notification-item">
                <div class="fw-bold">Community Event</div>
                <div class="small text-muted">Tree plantation drive this weekend in your area</div>
                <div class="small text-muted">3 days ago</div>
            </div>
        </div>
        
        <!-- Profile Panel -->
        <div class="profile-panel" id="profilePanel">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h5 id="profileUserName">Loading...</h5>
                <p class="text-muted" id="profileUserEmail">Loading...</p>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <i class="fas fa-user me-2"></i>Edit Profile
                </li>
                <li class="list-group-item">
                    <i class="fas fa-bell me-2"></i>Notification Settings
                </li>
                <li class="list-group-item">
                    <i class="fas fa-shield-alt me-2"></i>Privacy & Security
                </li>
                <li class="list-group-item">
                    <i class="fas fa-question-circle me-2"></i>Help & Support
                </li>
                <li class="list-group-item">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </li>
            </ul>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script>
        // =============================================
        // FIREBASE CONFIGURATION AND INITIALIZATION
        // =============================================
        
        // Default Firebase configuration (replace with your own)
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDemoKeyForAQIMonitorApp",
            authDomain: "aqi-monitor-demo.firebaseapp.com",
            projectId: "aqi-monitor-demo",
            storageBucket: "aqi-monitor-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        class FirebaseManager {
            constructor() {
                this.isInitialized = false;
                this.firebaseConfig = null;
                this.init();
            }

            init() {
                // Try to load saved Firebase config from localStorage
                const savedConfig = localStorage.getItem('firebaseConfig');
                
                if (savedConfig) {
                    try {
                        this.firebaseConfig = JSON.parse(savedConfig);
                        this.initializeFirebase();
                    } catch (error) {
                        console.error('Error parsing saved Firebase config:', error);
                        this.showFirebaseSetup();
                    }
                } else {
                    // Use default config for demo purposes
                    this.firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                    this.initializeFirebase();
                    this.showFirebaseSetup(); // Show setup instructions for first-time users
                }
            }

            initializeFirebase() {
                try {
                    // Initialize Firebase
                    firebase.initializeApp(this.firebaseConfig);
                    
                    // Initialize Firebase services
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();
                    this.storage = firebase.storage();
                    
                    this.isInitialized = true;
                    console.log('Firebase initialized successfully');
                    
                    // Hide setup instructions if shown
                    document.getElementById('firebase-setup').style.display = 'none';
                    
                    // Set up auth state listener
                    this.setupAuthListener();
                    
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    this.showFirebaseSetup();
                }
            }

            showFirebaseSetup() {
                document.getElementById('firebase-setup').style.display = 'block';
                document.getElementById('firebaseConfigInput').value = JSON.stringify(this.firebaseConfig, null, 2);
            }

            setupAuthListener() {
                this.auth.onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in
                        console.log('User signed in:', user.email);
                        this.updateUserProfile(user);
                        this.loadUserData(user.uid);
                    } else {
                        // User is signed out
                        console.log('User signed out');
                        this.showAuthSection();
                    }
                });
            }

            updateUserProfile(user) {
                document.getElementById('profileUserName').textContent = user.displayName || user.email;
                document.getElementById('profileUserEmail').textContent = user.email;
            }

            async loadUserData(userId) {
                try {
                    const userDoc = await this.db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        // Load user preferences and health data
                        if (userData.healthProfile) {
                            localStorage.setItem('healthProfile', JSON.stringify(userData.healthProfile));
                        }
                        if (userData.preferences) {
                            localStorage.setItem('userPreferences', JSON.stringify(userData.preferences));
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            async saveUserData(userId, data) {
                if (!this.isInitialized) return;
                
                try {
                    await this.db.collection('users').doc(userId).set(data, { merge: true });
                    console.log('User data saved successfully');
                } catch (error) {
                    console.error('Error saving user data:', error);
                }
            }

            async saveComplaint(complaintData) {
                if (!this.isInitialized) return null;
                
                try {
                    const complaintRef = await this.db.collection('complaints').add({
                        ...complaintData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending',
                        userId: this.auth.currentUser.uid
                    });
                    
                    return complaintRef.id;
                } catch (error) {
                    console.error('Error saving complaint:', error);
                    throw error;
                }
            }

            async uploadComplaintImage(file, complaintId) {
                if (!this.isInitialized) return null;
                
                try {
                    const storageRef = this.storage.ref();
                    const imageRef = storageRef.child(`complaints/${complaintId}/${file.name}`);
                    const snapshot = await imageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    return downloadURL;
                } catch (error) {
                    console.error('Error uploading image:', error);
                    throw error;
                }
            }
        }

        // =============================================
        // AUTHENTICATION SERVICE WITH FIREBASE
        // =============================================

        class AuthService {
            constructor(firebaseManager) {
                this.firebaseManager = firebaseManager;
            }

            async login(email, password) {
                try {
                    const userCredential = await this.firebaseManager.auth.signInWithEmailAndPassword(email, password);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    console.error('Login error:', error);
                    return { success: false, error: this.getAuthErrorMessage(error.code) };
                }
            }

            async register(userData) {
                try {
                    // Create user account
                    const userCredential = await this.firebaseManager.auth.createUserWithEmailAndPassword(
                        userData.email, 
                        userData.password
                    );

                    // Update user profile
                    await userCredential.user.updateProfile({
                        displayName: userData.fullName
                    });

                    // Save additional user data to Firestore
                    const userProfile = {
                        fullName: userData.fullName,
                        email: userData.email,
                        mobile: userData.mobile,
                        dob: userData.dob,
                        address: {
                            state: userData.state,
                            city: userData.city,
                            fullAddress: userData.address,
                            pincode: userData.pincode
                        },
                        healthProfile: {
                            respiratoryCondition: userData.respiratoryCondition || 'none',
                            cardiovascularCondition: userData.cardiovascularCondition || false,
                            smoker: userData.smoker || false,
                            activityLevel: userData.activityLevel || 'moderate',
                            ageGroup: userData.ageGroup || 'young'
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.firebaseManager.saveUserData(userCredential.user.uid, userProfile);

                    return { success: true, user: userCredential.user };
                } catch (error) {
                    console.error('Registration error:', error);
                    return { success: false, error: this.getAuthErrorMessage(error.code) };
                }
            }

            async resetPassword(email) {
                try {
                    await this.firebaseManager.auth.sendPasswordResetEmail(email);
                    return { success: true };
                } catch (error) {
                    console.error('Password reset error:', error);
                    return { success: false, error: this.getAuthErrorMessage(error.code) };
                }
            }

            async logout() {
                try {
                    await this.firebaseManager.auth.signOut();
                    return { success: true };
                } catch (error) {
                    console.error('Logout error:', error);
                    return { success: false, error: error.message };
                }
            }

            getAuthErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/invalid-email': 'Invalid email address format.',
                    'auth/user-disabled': 'This account has been disabled.',
                    'auth/user-not-found': 'No account found with this email.',
                    'auth/wrong-password': 'Incorrect password.',
                    'auth/email-already-in-use': 'An account with this email already exists.',
                    'auth/weak-password': 'Password should be at least 6 characters.',
                    'auth/network-request-failed': 'Network error. Please check your connection.'
                };
                
                return errorMessages[errorCode] || 'An unexpected error occurred. Please try again.';
            }
        }

        // =============================================
        // APPLICATION INITIALIZATION
        // =============================================

        // Global instances
        let firebaseManager;
        let authService;
        let dashboard;

        document.addEventListener('DOMContentLoaded', function() {
            initializeApplication();
        });

        function initializeApplication() {
            // Initialize Firebase Manager
            firebaseManager = new FirebaseManager();
            authService = new AuthService(firebaseManager);
            
            // Setup Firebase config save handler
            document.getElementById('saveFirebaseConfig').addEventListener('click', saveFirebaseConfig);
            
            // Initialize authentication UI
            initializeAuth();
            setupNavigation();
        }

        function saveFirebaseConfig() {
            try {
                const configInput = document.getElementById('firebaseConfigInput').value;
                const config = JSON.parse(configInput);
                localStorage.setItem('firebaseConfig', configInput);
                firebaseManager.firebaseConfig = config;
                firebaseManager.initializeFirebase();
                alert('Firebase configuration saved successfully!');
            } catch (error) {
                alert('Invalid Firebase configuration. Please check the format.');
            }
        }

        // =============================================
        // AUTHENTICATION UI FUNCTIONS
        // =============================================

        function initializeAuth() {
            // Tab switching
            document.getElementById('login-tab').addEventListener('click', () => switchTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => switchTab('register'));
            
            // Forgot password functionality
            document.getElementById('forgotPasswordLink').addEventListener('click', showForgotPassword);
            document.getElementById('backToLogin').addEventListener('click', showLoginForm);
            
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('resetPasswordForm').addEventListener('submit', handlePasswordReset);
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            
            // State-City mapping
            initializeStateCityMapping();
            
            // Respiratory condition toggle
            initializeHealthFormToggles();
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginSpinner = document.getElementById('loginSpinner');
            const loginButton = e.target.querySelector('button[type="submit"]');
            
            // Show loading state
            loginSpinner.style.display = 'inline-block';
            loginButton.disabled = true;
            
            const result = await authService.login(email, password);
            
            // Hide loading state
            loginSpinner.style.display = 'none';
            loginButton.disabled = false;
            
            if (result.success) {
                showDashboard();
            } else {
                alert('Login failed: ' + result.error);
            }
        }

        async function handleRegistration(e) {
            e.preventDefault();
            
            if (!validateRegistrationForm()) {
                return;
            }
            
            const formData = collectRegistrationData();
            const registerSpinner = document.getElementById('registerSpinner');
            const registerButton = e.target.querySelector('button[type="submit"]');
            
            // Show loading state
            registerSpinner.style.display = 'inline-block';
            registerButton.disabled = true;
            
            const result = await authService.register(formData);
            
            // Hide loading state
            registerSpinner.style.display = 'none';
            registerButton.disabled = false;
            
            if (result.success) {
                alert('Registration successful! Welcome to AQI Monitor.');
                showDashboard();
            } else {
                alert('Registration failed: ' + result.error);
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const resetSpinner = document.getElementById('resetSpinner');
            const resetButton = document.getElementById('sendResetLinkBtn');
            const resetMessage = document.getElementById('resetMessage');
            
            // Show loading state
            resetSpinner.style.display = 'inline-block';
            resetButton.disabled = true;
            
            const result = await authService.resetPassword(email);
            
            // Hide loading state
            resetSpinner.style.display = 'none';
            resetButton.disabled = false;
            
            if (result.success) {
                resetMessage.style.display = 'block';
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
            } else {
                alert('Password reset failed: ' + result.error);
            }
        }

        function collectRegistrationData() {
            return {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('mobile').value,
                dob: document.getElementById('dob').value,
                state: document.getElementById('state').value,
                city: document.getElementById('city').value,
                address: document.getElementById('address').value,
                pincode: document.getElementById('pincode').value,
                respiratoryCondition: document.getElementById('respiratoryCondition').value || 'none',
                cardiovascularCondition: document.querySelector('input[name="cardio"]:checked').value === 'yes',
                smoker: document.querySelector('input[name="smoker"]:checked').value === 'yes',
                activityLevel: document.getElementById('activityLevel').value,
                ageGroup: document.getElementById('ageGroup').value,
                password: document.getElementById('password').value
            };
        }

        function validateRegistrationForm() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPasswordReg').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return false;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return false;
            }
            
            return true;
        }

        // =============================================
        // DASHBOARD AND NAVIGATION FUNCTIONS
        // =============================================

        function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'flex';
            document.getElementById('firebase-setup').style.display = 'none';
            
            // Initialize dashboard if not already done
            if (!dashboard) {
                // You would initialize your dashboard here
                console.log('Dashboard initialized');
            }
        }

        function showAuthSection() {
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('auth-section').style.display = 'block';
            switchTab('login');
        }

        async function logout() {
            const result = await authService.logout();
            if (result.success) {
                showAuthSection();
            } else {
                alert('Logout failed: ' + result.error);
            }
        }

        // =============================================
        // HELPER FUNCTIONS (from original code)
        // =============================================

        function switchTab(tab) {
            if (tab === 'login') {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('register-tab').classList.remove('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            } else {
                document.getElementById('register-tab').classList.add('active');
                document.getElementById('login-tab').classList.remove('active');
                document.getElementById('register-form').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';
            }
        }

        function showForgotPassword(e) {
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function showLoginForm(e) {
            if (e) e.preventDefault();
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('resetMessage').style.display = 'none';
        }

        function nextStep(step) {
            if (!validateStep(step - 1)) return;
            
            document.querySelectorAll('.form-step').forEach(stepEl => stepEl.classList.remove('active'));
            document.getElementById(`step${step}-form`).classList.add('active');
            
            document.querySelectorAll('.step').forEach(stepIndicator => stepIndicator.classList.remove('active', 'completed'));
            for (let i = 1; i <= step; i++) {
                document.getElementById(`step${i}`).classList.add(i < step ? 'completed' : 'active');
            }
        }

        function prevStep(step) {
            document.querySelectorAll('.form-step').forEach(stepEl => stepEl.classList.remove('active'));
            document.getElementById(`step${step}-form`).classList.add('active');
            
            document.querySelectorAll('.step').forEach(stepIndicator => stepIndicator.classList.remove('active', 'completed'));
            for (let i = 1; i <= step; i++) {
                document.getElementById(`step${i}`).classList.add(i < step ? 'completed' : 'active');
            }
        }

        function validateStep(step) {
            // Add validation logic for each step
            return true;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        function initializeStateCityMapping() {
            const cityMap = {
                'Delhi': ['New Delhi', 'Central Delhi', 'North Delhi', 'South Delhi', 'East Delhi', 'West Delhi', 'North East Delhi', 'South West Delhi', 'Shahdara'],
                'Haryana': ['Gurugram', 'Faridabad', 'Sonipat', 'Panipat', 'Karnal', 'Rohtak', 'Hisar', 'Ambala', 'Yamunanagar'],
                'Uttar Pradesh': ['Noida', 'Ghaziabad', 'Meerut', 'Agra', 'Lucknow', 'Kanpur', 'Varanasi', 'Allahabad', 'Aligarh'],
                'Rajasthan': ['Jaipur', 'Jodhpur', 'Udaipur', 'Kota', 'Ajmer', 'Bikaner', 'Alwar', 'Bharatpur']
            };
            
            document.getElementById('state').addEventListener('change', function() {
                const citySelect = document.getElementById('city');
                citySelect.innerHTML = '<option value="">Select City</option>';
                if (this.value && cityMap[this.value]) {
                    cityMap[this.value].forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                }
            });
        }

        function initializeHealthFormToggles() {
            document.querySelectorAll('input[name="respiratory"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('respiratoryDetails').style.display = 
                        this.value === 'yes' ? 'block' : 'none';
                });
            });
        }

        // Navigation setup (from original code)
        function setupNavigation() {
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
            
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.id === 'logout-sidebar') {
                        e.preventDefault();
                        logout();
                        return;
                    }
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    if (window.innerWidth < 768) toggleSidebar();
                });
            });
            
            document.getElementById('notificationsBtn').addEventListener('click', function() {
                document.getElementById('notificationPanel').classList.toggle('open');
                document.getElementById('profilePanel').classList.remove('open');
            });
            
            document.getElementById('profileBtn').addEventListener('click', function() {
                document.getElementById('profilePanel').classList.toggle('open');
                document.getElementById('notificationPanel').classList.remove('open');
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.header-icon') && !e.target.closest('.notification-panel') && !e.target.closest('.profile-panel')) {
                    document.getElementById('notificationPanel').classList.remove('open');
                    document.getElementById('profilePanel').classList.remove('open');
                }
            });
            
            document.querySelector('.profile-panel .list-group-item:last-child').addEventListener('click', logout);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(`${section}-section-content`).classList.add('active');
        }

        // =============================================
        // COMPLAINT SUBMISSION WITH FIREBASE
        // =============================================

        async function submitComplaint(type, complaintData, images = []) {
            if (!firebaseManager.isInitialized) {
                alert('Firebase not configured. Please set up Firebase first.');
                return;
            }

            try {
                // Save complaint to Firestore
                const complaintId = await firebaseManager.saveComplaint(complaintData);
                
                // Upload images if any
                const imageUrls = [];
                for (const image of images) {
                    const imageUrl = await firebaseManager.uploadComplaintImage(image, complaintId);
                    imageUrls.push(imageUrl);
                }
                
                // Update complaint with image URLs
                if (imageUrls.length > 0) {
                    await firebaseManager.db.collection('complaints').doc(complaintId).update({
                        imageUrls: imageUrls
                    });
                }
                
                return { success: true, complaintId: complaintId };
            } catch (error) {
                console.error('Error submitting complaint:', error);
                return { success: false, error: error.message };
            }
        }

    </script>
</body>
</html>
